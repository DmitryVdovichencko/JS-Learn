# Асинхронность в JS. Базовые понятия.  :point_down:

## Просто о сложном.

[Перевод доклада Филипа Робертса с JSConf](https://www.youtube.com/watch?v=8cV4ZvHXQL4)

V8 - движок - среда выполнения JS кода в браузере. Он состоит из кучи __`heap`__ - это динамически распределяемая память и стек вызовов __`callstack`__ - здесь мы можем посмотреть какая функция какую вызвала.

WebAPIs - расширения браузера: __`DOM ajax setTimeout`__

event loop - цикл событий.

### Разбираемся:

JavaScript - однопоточная среда выполнения. Стэк вызовов один. В конкретный момент времени делается только что-то одно.





## Асинхронность

__Асинхронность__ выполнения JS кода заключается в том, что какая то часть программы будет выполнена _сейчас_, а другая _потом_.

Например мы выполняем асинхронный Ajax-запрос _сейчас_, и мы не получим данные до наступления _потом_.  :hourglass:

 &ndash;  Как определиться, когда наступит _потом_, чтобы обработать полученные данные :question:
 
 &ndash;  Используем __колбэки__ (функции обратного вызова) :boom:

```javascript 
ajax( "http://some.url.1", function myCallbackFunction(data){

	console.log( data ); // Даа, я получил данные!

} );
```

Еще один пример с асинхронностью &ndash; использование таймера `setTimeout`. В этом случае мы знаем что функция должна будет выполниться по истечение выдержки.


## Цикл событий

Движок JS работает в среде: в браузере, или, например, на сервере через NodeJS.

Существует механизм обрабатывающий части JS кода с течением времени при каждом вызове движка  &ndash; это цикл событий.

Среда выполнения составляет "расписание" событий ( выполнения JS кода ). Это как бесконечный цикл в котором каждая итерация  &ndash; это _тик_, и, если в нем есть событие, которое ждет своей очереди (наш колбек), оно будет выполнено.

## Параллельность

__Параллельность__ связана с __одновременным__ выполнением процессов.

Цикл событий, разбивает работу на задачи и выполняет их последовательно, __запрещая__ параллельный доступ и изменения в общей памяти.

Из-за однопоточности код внутри функции выолняется до тех пор пока не завершится &ndash; __от выполнения до завершения__.
Выполнение одной функции не может быть прервано выполнением другой.

```javascript
var a = 1;
var b = 2;

function foo() {
	a++;
	b = b * a;
	a = b + 3;
}

function bar() {
	b--;
	a = 8 + b;
	b = a * 2;
}

ajax( "http://some.url.1", foo );
ajax( "http://some.url.2", bar );
```
В данном случае мы не можем сказать что выполнится раньше foo или bar &ndash; эти функции находятся в состоянии гонки.

Если же, они могут быть выполнены независимо друг от друга, то непределенность порядка их выполнения вполне приемлема.

```javascript
var res = {};

function foo(results) {
	res.foo = results;
}

function bar(results) {
	res.bar = results;
}

ajax( "http://some.url.1", foo );
ajax( "http://some.url.2", bar );
```



Параллелизм заключается в том, что с течением времени чередуются две или несколько цепочек событий. Может показаться, что они работают одновременно (хотя в любой момент времени обрабатывается только одно событие).

Часто бывает необходимо выполнить некоторые координации взаимодействия между этими параллельными «процессами». Например, для обеспечения определенного порядка выполнения или предотвращения «состояния гонки». Эти «процессы» также могут разбиваться на более мелкие куски, позволяя другим «процессам» чередоваться.
